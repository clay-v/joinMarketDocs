<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JoinMarket Docs</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Make a coinjoin at any time">
    
    <link rel="preload" href="/joinMarketDocs/assets/css/0.styles.47da2780.css" as="style"><link rel="preload" href="/joinMarketDocs/assets/js/app.c61c6bdc.js" as="script"><link rel="preload" href="/joinMarketDocs/assets/js/2.96e2a3f8.js" as="script"><link rel="preload" href="/joinMarketDocs/assets/js/11.e4445083.js" as="script"><link rel="prefetch" href="/joinMarketDocs/assets/js/10.8bb8a683.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/12.fc2547b9.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/13.938ea1a9.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/14.2f99d1b3.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/15.72679292.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/16.cb0ef4ad.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/17.172e09bc.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/18.ae9324bc.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/19.3db863c1.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/20.90af7f93.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/21.b31423ce.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/22.7969ece1.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/23.ad6d9879.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/24.999ff3b4.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/25.d35fbd9a.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/26.b2e61fcb.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/27.d3754327.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/3.430d37e7.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/4.cee798b2.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/5.636e11bd.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/6.0af6a184.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/7.0d7dc195.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/8.b445599c.js"><link rel="prefetch" href="/joinMarketDocs/assets/js/9.92136928.js">
    <link rel="stylesheet" href="/joinMarketDocs/assets/css/0.styles.47da2780.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/joinMarketDocs/" class="home-link router-link-active"><!----> <span class="site-name">JoinMarket Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/joinMarketDocs/" aria-current="page" class="sidebar-link">Home</a></li><li><section class="sidebar-group depth-0"><a href="/joinMarketDocs/users" class="sidebar-heading clickable"><span>User Guide</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/joinMarketDocs/users/architecture-notes.html" class="sidebar-link">architecture-notes</a></li><li><a href="/joinMarketDocs/users/config-irc-update.html" class="sidebar-link">config-irc-update</a></li><li><a href="/joinMarketDocs/users/fidelity-bonds.html" class="sidebar-link">fidelity-bonds</a></li><li><a href="/joinMarketDocs/users/INSTALL.html" class="sidebar-link">INSTALL</a></li><li><a href="/joinMarketDocs/users/JOINMARKET-QT-GUIDE.html" class="sidebar-link">JOINMARKET-QT-GUIDE</a></li><li><a href="/joinMarketDocs/users/NATIVE-SEGWIT-UPGRADE.html" class="sidebar-link">NATIVE-SEGWIT-UPGRADE</a></li><li><a href="/joinMarketDocs/users/orderbook.html" class="sidebar-link">orderbook</a></li><li><a href="/joinMarketDocs/users/PAYJOIN.html" class="sidebar-link">PAYJOIN</a></li><li><a href="/joinMarketDocs/users/SNICKER.html" class="sidebar-link">SNICKER</a></li><li><a href="/joinMarketDocs/users/SOURCING-COMMITMENTS.html" class="sidebar-link">SOURCING-COMMITMENTS</a></li><li><a href="/joinMarketDocs/users/TODO.html" class="sidebar-link">TODO</a></li><li><a href="/joinMarketDocs/users/TESTING.html" class="sidebar-link">TESTING</a></li><li><a href="/joinMarketDocs/users/tumblerguide.html" class="sidebar-link">tumblerguide</a></li><li><a href="/joinMarketDocs/users/USAGE.html" class="sidebar-link">USAGE</a></li><li><a href="/joinMarketDocs/users/YIELDGENERATOR.html" class="sidebar-link">YIELDGENERATOR</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/joinMarketDocs/developers" class="sidebar-heading clickable router-link-active open"><span>Developer Guide</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/joinMarketDocs/developers/ArchOverview.html" class="sidebar-link">ArchOverview</a></li><li><a href="/joinMarketDocs/developers/High-level-design.html" class="sidebar-link">High-level-design</a></li><li><a href="/joinMarketDocs/developers/Joinmarket-messaging-protocol.html" aria-current="page" class="active sidebar-link">Joinmarket-messaging-protocol</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="joinmarket-messaging-protocol"><a href="#joinmarket-messaging-protocol" class="header-anchor">#</a> JoinMarket messaging protocol</h1> <p>The purpose of this document is to unambiguously define how joinmarket participants communicate. The messaging substrate allows for communication over multiple <code>MessageChannel</code> objects, managed by a single <code>MessageChannelCollection</code> object; see <a href="https://github.com/JoinMarket-Org/joinmarket/blob/master/joinmarket/message_channel.py" target="_blank" rel="noopener noreferrer">this module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>All messages are split into fields. Fields are currently separated with a single whitespace character (more than one whitespace char is not allowed.</p> <p>Messages have format:</p> <p>!command [[msg field 1] [msg field 2] ...]</p> <p>Messages are sent in two modes: public (broadcast to all other agents) or private (directed to a specific
agent and not seen by others).</p> <p>The first field always starts with the <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/message_channel.py#L8" target="_blank" rel="noopener noreferrer">command prefix<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, currently '!' and is completed with one of the following commands:</p> <table><thead><tr><th style="text-align:center;">Command word</th> <th style="text-align:center;"></th> <th style="text-align:center;">mode</th></tr></thead> <tbody><tr><td style="text-align:center;">reloffer</td> <td style="text-align:center;"></td> <td style="text-align:center;">public or private</td></tr> <tr><td style="text-align:center;">absoffer</td> <td style="text-align:center;"></td> <td style="text-align:center;">public or private</td></tr> <tr><td style="text-align:center;">orderbook</td> <td style="text-align:center;"></td> <td style="text-align:center;">public</td></tr> <tr><td style="text-align:center;">cancel</td> <td style="text-align:center;"></td> <td style="text-align:center;">public</td></tr> <tr><td style="text-align:center;">hp2</td> <td style="text-align:center;"></td> <td style="text-align:center;">public</td></tr> <tr><td style="text-align:center;">fill</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr> <tr><td style="text-align:center;">pubkey</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr> <tr><td style="text-align:center;">auth</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr> <tr><td style="text-align:center;">ioauth</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr> <tr><td style="text-align:center;">tx</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr> <tr><td style="text-align:center;">sig</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr> <tr><td style="text-align:center;">error</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr> <tr><td style="text-align:center;">push</td> <td style="text-align:center;"></td> <td style="text-align:center;">private</td></tr></tbody></table> <p>Private messages not starting with a command from this list are to be explicitly rejected.
Public messages not starting with a command from this list are to be ignored.
The initial command field is followed with zero or more message fields.</p> <h1 id="multi-part-messages"><a href="#multi-part-messages" class="header-anchor">#</a> Multi-part messages</h1> <p>An unencrypted message may optionally contain more than one command. The message is first split into sub-messages on the command prefix, then each &quot;sub-message&quot; is treated as a distinct message, applying the rules as listed above.</p> <p>Note that this is not allowed for encrypted messages, which are only allowed to send a single command field at the start of the message. It <strong>is</strong> currently used for the <code>reloffer</code> and <code>absoffer</code> commands.</p> <h1 id="irc-specific-feature-chunks"><a href="#irc-specific-feature-chunks" class="header-anchor">#</a> IRC-specific feature: chunks</h1> <p>Messages are split into chunks for passing over an IRC messaging channel; this code is found therefore in the <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/irc.py#L236-L252" target="_blank" rel="noopener noreferrer">irc module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Chunks are terminated with the chunk delimiter ';', unless it is the final chunk, which case the chunk delimiter is '~'.</p> <p>Messages are split into chunks before sending over the messaging channel, and the decision for chunk size
is set globally as a function of the messaging implementation (currently: <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/irc.py#L18" target="_blank" rel="noopener noreferrer">450 characters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p> <p>Future non-IRC message channel implementations thus may or may not use this feature, depending on their characteristics, but all IRC implementations must use it.</p> <h1 id="encryption"><a href="#encryption" class="header-anchor">#</a> Encryption</h1> <p>Public messages (broadcast to all other participants) are never encrypted.</p> <p>Private messages of command-type <code>fill</code>, <code>pubkey</code>, <code>error</code>, <code>orderbook</code>, <code>push</code>, <code>reloffer</code> and <code>absoffer</code> are sent in plaintext.
Messages of command-type <code>ioauth</code>, <code>auth</code>, <code>tx</code> and <code>sig</code> are sent encrypted.
These rules are enforced <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/message_channel.py#L13-L16" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/message_channel.py#L818-L826" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>All encrypted messages are <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/enc_wrapper.py#L91-L99" target="_blank" rel="noopener noreferrer">base64 encoded<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> before being passed onto the message channel.</p> <p>For encrypted messages, the entire set of message fields are sent as a single encrypted block (including the whitespace delimiters between the message fields). The command field and the chunk indicator field (for IRC) are sent in plaintext. (TODO: <a href="https://github.com/JoinMarket-Org/joinmarket/issues/352" target="_blank" rel="noopener noreferrer">pad messages to improve privacy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>; eg, to combat MITM correlation of ioauth and sig messages with the inputs belonging to a liquidity provider).</p> <p>For clarification, the sequence for sending of encrypted messages is therefore plaintext--&gt;encryption--&gt;base64encoding--&gt;chunking--&gt; prepend !command to first chunk and add chunk delimiters --&gt;send to message channel (private message for encryption). And the reverse for receiving.</p> <h1 id="for-multiple-message-channels-message-signatures-for-anti-spoofing"><a href="#for-multiple-message-channels-message-signatures-for-anti-spoofing" class="header-anchor">#</a> For multiple message channels: message signatures for anti-spoofing</h1> <h5 id="pubkey-based-nicks"><a href="#pubkey-based-nicks" class="header-anchor">#</a> Pubkey-based nicks</h5> <p>The username/nick/nym for the Joinmarket bot is ephemeral-per-session, but is constructed in such a way that it can be signed for, so that it is not possibly to successfully spoof that user by registering the same nick on another active message channel. The nick is constructed as follows:</p> <p>A 32 byte private key is generated at random.</p> <p>A Bitcoin secp256k1 public key is <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/message_channel.py#L114" target="_blank" rel="noopener noreferrer">created<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> using it.</p> <p>nick = one &quot;type&quot; byte (currently &quot;J&quot;) + one version byte (current <code>JM_VERSION</code> protocol value, <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/configure.py#L55" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) + Base58 (not Base58Check) of: first <code>joinmarket.message_channel.NICK_HASH_LEN</code> bytes of sha256 of : ephemeral per-bot-process public key as just described.</p> <p>If length(nick) &lt; <code>joinmarket.message_channel.NICK_MAX_ENCODED</code>, right pad with 'O' char to that length.</p> <p>Thus according to current rules the nick is 16 characters in length, consisting of one type byte, one version byte and 14 bytes of pubkey-hash (right padded if necessary to fix length).</p> <h5 id="applying-signatures-to-private-messages"><a href="#applying-signatures-to-private-messages" class="header-anchor">#</a> Applying signatures to private messages.</h5> <p><strong>All</strong> private messages (whether encrypted or not) are extended with the additional fields <pubkey><signature> where pubkey is the Bitcoin pubkey mentioned above, hex encoded, and the signature is a Bitcoin signature, also hex encoded (TODO: this could be substantially improved in encoding size with pubkey recovery, and more compact encoding). See <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/message_channel.py#L851-L858" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</signature></pubkey></p> <p>As defence against replaying the same signature on different message channels, note specifically that the plaintext which is signed is <code>message+hostid</code>, see <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/message_channel.py#L855" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, where <code>hostid</code> is the hostid of this specific MessageChannel object, for IRC this is the &quot;network&quot; field passed from the IRC server.</p> <p>Note that since this extension to the message occurs in the abstract message class MessageChannel, any chunking as described above occurs after it. The <code>pubkey</code> and <code>sig</code> are just 2 additional fields for any private message sent.</p> <p>All received private messages are verified against the nick of the sender <a href="https://github.com/JoinMarket-Org/joinmarket/blob/35dc60848c201f1c071a00c885969d1cc458cbbf/joinmarket/message_channel.py#L932-L939" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to prevent the threat of spoofing nicks.</p> <h1 id="valid-conversation-sequences"><a href="#valid-conversation-sequences" class="header-anchor">#</a> Valid conversation sequences:</h1> <p>(Announcements, not interactive/conversation):</p> <table><thead><tr><th style="text-align:center;">TAKER</th> <th style="text-align:center;"></th> <th style="text-align:center;">MAKER</th></tr></thead> <tbody><tr><td style="text-align:center;"></td> <td style="text-align:center;">&lt;&lt;&lt;</td> <td style="text-align:center;">![rel|abs]offer (public)</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">&lt;&lt;&lt;</td> <td style="text-align:center;">!cancel(public)</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">&lt;&lt;&lt;</td> <td style="text-align:center;">!hp2(public)</td></tr></tbody></table> <table><thead><tr><th style="text-align:center;">TAKER</th> <th style="text-align:center;"></th> <th style="text-align:center;">MAKER</th></tr></thead> <tbody><tr><td style="text-align:center;">!orderbook(public)</td> <td style="text-align:center;">&gt;&gt;&gt;</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">&lt;&lt;&lt;</td> <td style="text-align:center;">![rel|abs]order (private)</td></tr></tbody></table> <table><thead><tr><th style="text-align:center;">TAKER</th> <th style="text-align:center;"></th> <th style="text-align:center;">MAKER</th></tr></thead> <tbody><tr><td style="text-align:center;">!fill(private)</td> <td style="text-align:center;">&gt;&gt;&gt;</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">&lt;&lt;&lt;</td> <td style="text-align:center;">!pubkey(private)</td></tr> <tr><td style="text-align:center;">!auth(private)</td> <td style="text-align:center;">&gt;&gt;&gt;</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">&lt;&lt;&lt;</td> <td style="text-align:center;">!ioauth(private)</td></tr> <tr><td style="text-align:center;">!tx(private)</td> <td style="text-align:center;">&gt;&gt;&gt;</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">&lt;&lt;&lt;</td> <td style="text-align:center;">!sig(private)</td></tr></tbody></table> <p>Each taker may speak to many makers simultaneously and each maker may speak to many takers simultaneously in private.</p> <h4 id="private-conversation-in-detail"><a href="#private-conversation-in-detail" class="header-anchor">#</a> Private conversation in detail:</h4> <p>See &quot;Definitions&quot; section below for the key for the abbreviations.</p> <div class="language- extra-class"><pre class="language-text"><code>1: M: !ordertype [order details]!ordertype [orderdetails]... (NS)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>2: T: !fill order-id amount tencpubkey C (NS)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>3: M: !pubkey mencpubkey (NS)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>4: T*: !auth O (NS)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>5: M*: !ioauth ulist maker_auth_pub coinjoinA changeA B(mencpubkey) (NS)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>6: T*: !tx txhex (NS)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>7: M*: !sig txsig (NS)
</code></pre></div><h4 id="notes"><a href="#notes" class="header-anchor">#</a> Notes:</h4> <p>After step 2, if provided commitment is blacklisted according to maker's policy, maker quits. Current implementation stores utxo commitments (note that there are <code>taker_utxo_retries</code> possible commitments per utxo, and that the commitments do not reveal the utxo, thus effectively the same utxo can be tried that many times) in a file named <code>blacklist</code>.</p> <p>After step 4, if PoDLE verification fails, the maker quits before sending <code>!ioauth</code>, thereby disallowing receipt of owned utxos.</p> <p>For PODLE calculation see <a href="https://gist.github.com/AdamISZ/9cbba5e9408d23813ca8#defence-2-committing-to-a-utxo-in-publicplaintext-at-the-start-of-the-handshake" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>In 5, <code>!ioauth ulist maker_auth_pub coinjoinA changeA B(mencpubkey) (NS)</code>, returned by maker, it's to be noted here that <code>maker_auth_pub</code> is needed to use an <em>input</em> , rather than an output, pubkey, as the anti-MITM key for the reason that a maker might not always own the coinjoin output key (see e.g. patientsendpayment mixing of maker/taker role).</p> <p>Nick signature: currently re-calculates expected nick from given pubkey then validates signature against the entire message before NS. In future could cut out ~ 66 bytes by making use of secp256k1 pubkey recovery. The purpose of this feature is to prevent impersonation of a running bot by using its nick on a different message channel (see issue 568).</p> <p>Taker side auth of utxo has been REMOVED, see overview of argument <a href="https://github.com/JoinMarket-Org/joinmarket/issues/171#issuecomment-235868269" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and see also <a href="https://github.com/JoinMarket-Org/joinmarket/pull/90#issuecomment-108648823" target="_blank" rel="noopener noreferrer">earlier background<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h4 id="definitions"><a href="#definitions" class="header-anchor">#</a> Definitions</h4> <p><strong>T</strong>: taker</p> <p><strong>M</strong>: maker</p> <p><strong>*</strong> : indicates message <strong>not including</strong> NS is encrypted</p> <p><strong>[t,m]encpubkey</strong> : taker and maker encryption pubkeys, per transaction, for ECDH setup</p> <p><strong>C</strong>: single data field for commitment to a utxo by taker, by default for PoDLE (C=H(P2)). First byte is commitment type, default &quot;P&quot; for PoDLE.</p> <p><strong>B(p)</strong>: bitcoin signature of an encryption pubkey p (signed message format standardised as for Bitcoin Core etc.)</p> <p>Commitment data for default PoDLE construct:</p> <p><strong>O</strong>: commitment opening serialization, consists of the following fields separated by a field separator (default '|'):</p> <p><strong>U</strong>: utxo used for PoDLE (not necessarily from wallet)</p> <p><strong>P</strong>: pubkey used for PoDLE (not necessarily from wallet)</p> <p><strong>P2</strong>: shifted base point pubkey for PoDLE</p> <p><strong>s, e</strong>: schnorr sig values for PoDLE</p> <p><strong>maker_auth_pub</strong>: pubkey of keypair used to authorize and setup encryption by maker (must correspond to one of maker's input addresses)</p> <p><strong>coinjoinA</strong>: coinjoin address used by maker</p> <p><strong>changeA</strong>: change address used by maker</p> <p><strong>ulist</strong>: list of utxos that maker proposes to be used in transaction</p> <p><strong>(NS)</strong>: nick signature (either of form pub, sig or from pubkey recovery, bitcoin type) : message to be signed is the whole message to be sent + message channel identifier str(<code>serverport</code>) (the latter to prevent cross-channel replay).</p> <p>This document is not yet complete. Edit proposals welcomed.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/joinMarketDocs/developers/High-level-design.html" class="prev">
        High-level-design
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/joinMarketDocs/assets/js/app.c61c6bdc.js" defer></script><script src="/joinMarketDocs/assets/js/2.96e2a3f8.js" defer></script><script src="/joinMarketDocs/assets/js/11.e4445083.js" defer></script>
  </body>
</html>
